<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyConnect - Find Your Study Buddy</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <aside class="sidebar">
        <h1>StudyConnect</h1>
        
        <div class="status-selector">
            <h2>Set Your Status</h2>
            <label for="class-select">Class:</label>
            <select id="class-select" name="class" required>
                <option value="">Select Class</option>
                <option value="8">Class 8</option>
                <option value="9">Class 9</option>
                <option value="10">Class 10</option>
                <option value="11">Class 11</option>
                <option value="12">Class 12</option>
            </select>
            <label for="subject-select">Subject:</label>
            <select id="subject-select" name="subject" required>
                <option value="">Select Subject</option>
                <option value="maths">Maths</option>
                <option value="physics">Physics</option>
            </select>
            <label for="chapter-select">Chapter:</label>
            <select id="chapter-select" name="chapter" required>
                <option value="">Select Chapter</option>
                <!-- Chapters will be populated by JavaScript -->
            </select>
            <label for="topic-select">Topic:</label>
            <select id="topic-select" name="topic">
                <option value="">Select Topic</option>
                <!-- Topics will be populated by JavaScript -->
            </select>
            <button id="set-status-btn">Set Status & Find</button>
        </div>

    </aside>

    <main id="main-content" class="main-content">
        <!-- This view is shown initially -->
        <div id="initial-student-view">
            <!-- Filtered students will appear here before a chat is selected -->
        </div>

        <!-- This view is shown after a user is selected -->
        <div id="chat-view" class="hidden">
            <div id="chat-area">
                <div class="chat-header-container">
                    <h2 id="chat-header">Chat</h2>
                    <button id="clear-doubt-btn" class="chat-btn">Mark as Cleared</button>
                </div>
                <div id="chat-window" class="chat-window">
                    <!-- Messages will appear here -->
                </div>
                <div id="chat-input-container" class="chat-input">
                    <input id="chat-input-field" type="text" placeholder="Type a message...">
                    <button id="send-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M1.101 21.757 23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
                    </button>
                </div>
            </div>
            <div id="chat-sidebar" class="student-list">
                <h3 id="chat-sidebar-header">Filtered Users</h3>
                <div id="chat-sidebar-container">
                    <!-- The list of filtered users for quick switching -->
                </div>
            </div>
        </div>
    </main>

    <script src="data.js"></script> <!-- Data file is imported here -->
    <script>
        // DOM Element References
        const classSelect = document.getElementById('class-select');
        const subjectSelect = document.getElementById('subject-select');
        const chapterSelect = document.getElementById('chapter-select');
        const topicSelect = document.getElementById('topic-select');
        const setStatusBtn = document.getElementById('set-status-btn');
        const chatHeader = document.getElementById('chat-header');
        const chatWindow = document.getElementById('chat-window');
        const sendBtn = document.getElementById('send-btn');
        const chatInputField = document.getElementById('chat-input-field');
        const initialStudentView = document.getElementById('initial-student-view');
        const chatView = document.getElementById('chat-view');
        const chatSidebarContainer = document.getElementById('chat-sidebar-container');

        const clearDoubtBtn = document.getElementById('clear-doubt-btn');

        let currentFilteredStudents = []; // To store the list of filtered students
        let clearedStudentIds = new Set(); // To track students whose doubts are cleared
        let activeChatStudentId = null; // To track the currently active chat
        // --- Functions ---

        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function sendMessage() {
            const messageText = chatInputField.value.trim();

            if (messageText === '') {
                return; // Don't send empty messages
            }

            const messageElement = document.createElement('div');
            messageElement.className = 'message sent';
            messageElement.innerHTML = `
                <div>
                    ${messageText}
                    <span class="timestamp">${getCurrentTime()}</span>
                </div>
            `;

            chatWindow.appendChild(messageElement);
            chatInputField.value = ''; // Clear the input
            chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to the latest message
        }

        function openChatWithUser(studentId, studentName) {
            // Show chat view and hide initial view
            initialStudentView.classList.add('hidden');
            chatView.classList.remove('hidden');

            // Set the active chat user
            activeChatStudentId = studentId;

            // Update chat header
            chatHeader.textContent = `Chat with ${studentName}`;

            // Load dummy messages
            chatWindow.innerHTML = `
                <div class="message received">
                    <strong>${studentName}</strong>
                    <div>
                        Hey! I saw you're also studying this chapter. Stuck on anything?
                        <span class="timestamp">${getCurrentTime()}</span>
                    </div>
                </div>
                <div class="message sent">
                    <div>
                        Yeah, just starting out. How about you?
                        <span class="timestamp">${getCurrentTime()}</span>
                    </div>
                </div>
            `;
            chatInputField.focus();
        }

        function renderStudentList(students, container) {
            container.innerHTML = ''; // Clear current list
            if (students.length === 0) {
                container.innerHTML = '<p style="padding: 10px; text-align: center; color: var(--dark-gray);">No students found.</p>';
                return;
            }

            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.dataset.studentId = student.id;
                card.dataset.studentName = student.name;

                let buttonHtml;
                if (clearedStudentIds.has(student.id.toString())) {
                    card.classList.add('doubt-cleared');
                    buttonHtml = `<span class="cleared-indicator">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path></svg>
                    </span>`;
                } else {
                    buttonHtml = `<button class="chat-btn" data-student-id="${student.id}" data-student-name="${student.name}">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
                    </button>`;
                }

                card.innerHTML = `
                    <div><span class="status-dot"></span><span class="student-name">${student.name}</span></div>
                    ${buttonHtml}
                `;
                container.appendChild(card);
            });
        }

        function updateChapters() {
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;

            chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            topicSelect.innerHTML = '<option value="">Select Topic</option>';

            if (selectedClass && selectedSubject && studyData[selectedSubject]?.[selectedClass]) {
                const chapters = studyData[selectedSubject][selectedClass];
                for (const chapterId in chapters) {
                    const option = document.createElement('option');
                    option.value = chapterId;
                    option.textContent = chapters[chapterId].name;
                    chapterSelect.appendChild(option);
                }
            }
        }

        function updateTopics() {
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            const selectedChapter = chapterSelect.value;

            topicSelect.innerHTML = '<option value="">Select Topic</option>';

            if (selectedClass && selectedSubject && selectedChapter && studyData[selectedSubject]?.[selectedClass]?.[selectedChapter]) {
                const topics = studyData[selectedSubject][selectedClass][selectedChapter].topics;
                topics.forEach((topic, index) => {
                    const option = document.createElement('option');
                    option.value = `${selectedChapter}-topic${index + 1}`;
                    option.textContent = topic;
                    topicSelect.appendChild(option);
                });
            }
        }

        // --- Event Listeners ---

        classSelect.addEventListener('change', updateChapters);
        subjectSelect.addEventListener('change', updateChapters);
        chapterSelect.addEventListener('change', updateTopics);

        setStatusBtn.addEventListener('click', () => {
            const selectedChapterOption = chapterSelect.options[chapterSelect.selectedIndex];
            const selectedTopicOption = topicSelect.options[topicSelect.selectedIndex];
            const selectedChapterId = selectedChapterOption.value;

            if (selectedChapterId) {
                currentFilteredStudents = studentData.filter(student => student.studying.includes(selectedChapterId));
                renderStudentList(currentFilteredStudents, initialStudentView); // Update main initial view
                renderStudentList(currentFilteredStudents, chatSidebarContainer); // Also update the right sidebar in chat view

            } else {
                alert('Please select a Class, Subject, and Chapter first!');
                currentFilteredStudents = studentData;
                renderStudentList(currentFilteredStudents, initialStudentView);
                renderStudentList(currentFilteredStudents, chatSidebarContainer);
            }
        });

        // Listener for the main student view
        initialStudentView.addEventListener('click', (event) => {
            const card = event.target.closest('.student-card');
            if (card) {
                renderStudentList(currentFilteredStudents, chatSidebarContainer); // Populate right sidebar
                openChatWithUser(card.dataset.studentId, card.dataset.studentName);
            }
        });

        // Listener for the right sidebar to switch chats
        chatSidebarContainer.addEventListener('click', (event) => {
            const card = event.target.closest('.student-card');
            if (card) {
                openChatWithUser(card.dataset.studentId, card.dataset.studentName);
            }
        });

        clearDoubtBtn.addEventListener('click', () => {
            if (activeChatStudentId) {
                clearedStudentIds.add(activeChatStudentId.toString());
                // Re-render the right sidebar to show the "cleared" status
                renderStudentList(currentFilteredStudents, chatSidebarContainer);
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        chatInputField.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevents creating a new line
                sendMessage();
            }
        });

        // Activate chat input on any key press
        window.addEventListener('keydown', (event) => {
            const activeElement = document.activeElement;
            // Check if we are not already typing somewhere
            if (event.key.length === 1 && !['INPUT', 'SELECT', 'TEXTAREA'].includes(activeElement.tagName)) {
                chatInputField.focus();
            }
        });

        window.addEventListener('load', () => {
            currentFilteredStudents = studentData;
            renderStudentList(studentData, initialStudentView); // Populate main view initially
        });
    </script>
</body>
</html>
